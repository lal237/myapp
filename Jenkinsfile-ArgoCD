pipeline {
    agent any

    environment {
        SONARQUBE_SERVER = 'sonar-server'
        SCANNER_HOME     = tool 'sonar-scanner'
        NB = '${env.BUILD_NUMBER}'
        MAVEN_IMAGE = "houcemdevops/maven-argo"
    }

    stages {

        stage('Clone') {
            steps {
               checkout scm
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE_SERVER}") {
                    sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                          -Dsonar.projectKey=maven-demo \
                          -Dsonar.projectName=maven-demo \
                          -Dsonar.sources=.
                    """
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }
        

        stage('Trivy File Scan'){
          steps{

               sh 'trivy fs .  > rapportfs.txt'
          }
        }

        stage('Build Image Docker'){
           steps{
               script{
                 echo "${env.MAVEN_IMAGE}:${BUILD_NUMBER}"
                 docker.build("${env.MAVEN_IMAGE}:${BUILD_NUMBER}",'.')
               }  
           }
        }
        
        stage('trivy image'){
            steps{

                sh "trivy image ${env.MAVEN_IMAGE}:${BUILD_NUMBER} > rapportimage.txt"
            }
        }
        

        stage('Docker Push'){
            steps{
                script{
                withDockerRegistry(credentialsId: 'id_docker',url: 'https://index.docker.io/v1/') {
                              sh "docker push ${env.MAVEN_IMAGE}:${BUILD_NUMBER}"
                     }
            }
            }
        }







        stage('Deploy') {
            environment{

                GIT_REPO_NAME = "myapp-j2e-g20"
                GIT_USER_NAME = "houcem"
            }
            steps {
                dir('k8s'){
                  withCredentials([string(credentialsId: 'Gitlab', variable: 'gitlab')]) {
                     sh '''
                     git config user.name "houcem"
                     git config user.email "houcem@test.com"
                     echo "${BUILD_NUMBER}
                     imageTag=$(grep -oP '?<=houcemdevops/maven-argo:)[^ ]+' deploy.yaml)
                     echo $imageTag
                     sed -i "s|houcemdevops/maven-argo:${imageTag}|${env.MAVEN_IMAGE}:${BUILD_NUMBER}|" deploy.yaml
                     git add deploy.yaml
                     git commit -m "Update deployment Image to version \${BUILD_NUMBER}"
                     git push https://${GIT_USER_NAME}:${gitlab}@repo-dev.efi-academy.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:master
                     '''
    

}

                }
              
            }
        }
    }
}
