pipeline {
   agent any

     environment {

        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        MAVEN_IMAGE = "houcemdevops/maven-app:${env.BUILD_NUMBER}"
        
     }
   
    stages {
        stage('Clone'){
            steps{
              checkout scm 
                
            }
        }
        
        stage('Build IMAGE'){
            steps{
               script  {

                   docker.build("${env.MAVEN_IMAGE}", '.')
               }
            }
        }  
        
         stage('PUSH IMAGE'){
            steps{
               script  {
                   withDockerRegistry(credentialsId: 'id_docker') {
                                     docker.image("${env.MAVEN_IMAGE}").push()

                }

                   
               }
            }
        }  




        stage('Deploy K8s'){
            steps{
              
                 script {
                 withKubeCredentials(kubectlCredentials: [[caCertificate: '', clusterName: '', contextName: '', credentialsId: 'id_k8s', namespace: '', serverUrl: '']]) {
                         sh '''
                            sed -i "s|{{MAVEN_IMAGE}}|$MAVEN_IMAGE|g" maven.yaml

                            kubectl apply -f maven.yaml
                            sleep 10 
                            kubectl get all -n houcemapp

                            '''
                         
} 

                 }  

                
            }
        }
       
    }
    
}
